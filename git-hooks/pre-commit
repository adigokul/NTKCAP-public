#!/bin/bash

# Pre-commit hook to ensure proper email configuration
# This script will check and optionally prompt for email and name before each commit

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}=========================================${NC}"
echo -e "${BLUE}Git Commit Author Configuration Check${NC}"
echo -e "${BLUE}=========================================${NC}"

# Get current git user configuration
current_email=$(git config user.email)
current_name=$(git config user.name)

echo "Current settings:"
echo "  Name: ${current_name:-"(not set)"}"
echo "  Email: ${current_email:-"(not set)"}"
echo ""

# Check if both name and email are properly configured
needs_config=false

# Check email
if [ -z "$current_email" ] || [ "$current_email" = "ntk@example.com" ] || [[ "$current_email" =~ @.*\.\(none\) ]]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Email needs to be configured${NC}"
    needs_config=true
fi

# Check name  
if [ -z "$current_name" ] || [ "$current_name" = "NTK User" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Name needs to be configured${NC}"
    needs_config=true
fi

# Always ask if user wants to change author for this commit
if [ "$needs_config" = false ]; then
    echo -e "${GREEN}‚úì Git identity is properly configured${NC}"
    echo ""
    printf "Do you want to commit as a different author? (y/N): "
    read -r change_author < /dev/tty
    
    if [[ "$change_author" =~ ^[Yy]$ ]]; then
        needs_config=true
        echo -e "${BLUE}üìù Setting custom author for this commit...${NC}"
    fi
fi

# If configuration is needed, prompt user
if [ "$needs_config" = true ]; then
    echo ""
    echo -e "${YELLOW}Please configure your Git identity:${NC}"
    
    # Prompt for email
    if [ -z "$current_email" ] || [ "$current_email" = "ntk@example.com" ] || [[ "$current_email" =~ @.*\.\(none\) ]] || [[ "$change_author" =~ ^[Yy]$ ]]; then
        echo ""
        printf "Enter email address (current: ${current_email:-"none"}): "
        read -r new_email < /dev/tty
        if [ ! -z "$new_email" ] && [[ "$new_email" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
            git config user.email "$new_email"
            echo -e "${GREEN}‚úì Email set to: $new_email${NC}"
        elif [ ! -z "$new_email" ]; then
            echo -e "${RED}‚ùå Invalid email format. Commit aborted.${NC}"
            exit 1
        elif [ -z "$current_email" ] || [ "$current_email" = "ntk@example.com" ] || [[ "$current_email" =~ @.*\.\(none\) ]]; then
            echo -e "${RED}‚ùå Email is required. Commit aborted.${NC}"
            exit 1
        else
            echo -e "${BLUE}‚úì Keeping current email: $current_email${NC}"
        fi
    fi
    
    # Prompt for name
    if [ -z "$current_name" ] || [ "$current_name" = "NTK User" ] || [[ "$change_author" =~ ^[Yy]$ ]]; then
        echo ""
        printf "Enter full name (current: ${current_name:-"none"}): "
        read -r new_name < /dev/tty
        if [ ! -z "$new_name" ]; then
            git config user.name "$new_name"
            echo -e "${GREEN}‚úì Name set to: $new_name${NC}"
        elif [ -z "$current_name" ] || [ "$current_name" = "NTK User" ]; then
            echo -e "${RED}‚ùå Name is required. Commit aborted.${NC}"
            exit 1
        else
            echo -e "${BLUE}‚úì Keeping current name: $current_name${NC}"
        fi
    fi
    
    # Get final author info
    final_name=$(git config user.name)
    final_email=$(git config user.email)
    
    echo ""
    echo -e "${GREEN}=========================================${NC}"
    echo -e "${GREEN}Configuration completed!${NC}"
    echo -e "${GREEN}Final commit author:${NC}"
    echo -e "${GREEN}  Name:  $final_name${NC}"
    echo -e "${GREEN}  Email: $final_email${NC}"
    echo -e "${GREEN}=========================================${NC}"
    
    # For amend operations, we need to set the author environment variables
    # Export these so git commit will use them
    export GIT_AUTHOR_NAME="$final_name"
    export GIT_AUTHOR_EMAIL="$final_email"
    export GIT_COMMITTER_NAME="$final_name"
    export GIT_COMMITTER_EMAIL="$final_email"
    
    echo -e "${BLUE}üîß Environment variables set for this commit${NC}"
else
    echo -e "${GREEN}=========================================${NC}"
fi

echo "Proceeding with commit..."
exit 0
